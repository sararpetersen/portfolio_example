---
const { projects: propProjects } = Astro.props;

const fetchCards = async () => {
  const response = await fetch("https://bbmabdbbjpfqoapbtstm.supabase.co/rest/v1/portfolio_cases?order=id.asc", {
    method: "GET",
    headers: {
      apikey:
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJibWFiZGJianBmcW9hcGJ0c3RtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI0NjkwNDYsImV4cCI6MjA1ODA0NTA0Nn0.gFnw6GZiMFOCMwy6rAcQFzoK0_qUJCwKNpl-XGzy574",
    },
  });
  return response.ok ? await response.json() : [];
};

const projects = propProjects ?? (await fetchCards());
---

<!-- Carousel -->
<div class="carousel w-full col-span-12">
  <ul id="project-cards" class="carousel-track grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    {
      projects.map((project) => (
        <li
          class="h-[300px] relative overflow-hidden rounded-2xl group hover:-translate-y-1 transition duration-300 ease-in-out border-l-4 border border-gray-200 hover:border-gray-300"
          data-id={project.id ?? ""}
          data-name={project.name ? project.name.toLowerCase() : ""}
        >
          {project.slug === "no-project" ? (
            <div aria-label={`View project: ${project.name}`}>
              <img src={project.image} alt={project.name} class="w-full h-full object-cover z-0" />

              <div class="absolute inset-0 bg-gray-950 bg-opacity-75 opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-10">
                <div class="absolute bottom-0 left-0 right-0 p-4">
                  <h1 class="text-h4-mobile font-bold text-gray-50">{project.name}</h1>
                  <h2 class="text-h4-mobile font-light italic pb-2 text-gray-50">{project.semester}</h2>

                  <div class="flex flex-row flex-wrap gap-2 py-2">
                    {project.tools &&
                      project.tools.map((tool) => (
                        <p class="rounded-full px-4 py-2 font-semibold border border-blue-500 uppercase bg-blue-500 text-gray-50 text-sm">{tool}</p>
                      ))}
                  </div>
                </div>
              </div>
            </div>
          ) : (
            <a href={`/${project.slug}`} aria-label={`View project: ${project.name}`}>
              <img src={project.image} alt={project.name} class="w-full h-full object-cover z-0" />

              <div class="absolute inset-0 bg-gray-950 bg-opacity-75 opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-10">
                <div class="absolute bottom-0 left-0 right-0 p-4">
                  <h1 class="text-h4-mobile font-bold text-gray-50">{project.name}</h1>
                  <h2 class="text-h4-mobile font-light italic pb-2 text-gray-50">{project.semester}</h2>

                  <div class="flex flex-row flex-wrap gap-2 py-2">
                    {project.tools &&
                      project.tools.map((tool) => (
                        <p class="rounded-full px-4 py-2 font-semibold border border-blue-500 uppercase bg-blue-500 text-gray-50 text-sm">{tool}</p>
                      ))}
                  </div>
                </div>
              </div>
            </a>
          )}
        </li>
      ))
    }
  </ul>
</div>

<script>
  import { inView } from "motion";

  document.addEventListener("DOMContentLoaded", () => {
    const cards = Array.from(document.querySelectorAll("#project-cards > li")) as HTMLElement[];

    // Keyboard accessibility
    cards.forEach((card) => {
      card.setAttribute("tabindex", "0");
      card.addEventListener("keydown", (e: KeyboardEvent) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          const link = card.querySelector("a");
          if (link) link.click();
        }
      });
    });

    const reduceMotion = document.body.classList.contains("reduce-motion") || window.matchMedia("(prefers-reduced-motion: reduce)").matches;

    if (reduceMotion) return;

    const container = document.getElementById("project-cards");
    let hasAnimated = false;

    // Start hidden
    cards.forEach((card) => {
      card.style.opacity = "0";
    });

    function animateStaggeredByPosition() {
      // Sort by actual visual position (top-to-bottom, left-to-right)
      const sorted = [...cards].sort((a, b) => {
        const ra = a.getBoundingClientRect();
        const rb = b.getBoundingClientRect();

        // Primary: top
        const topDiff = ra.top - rb.top;
        if (Math.abs(topDiff) > 5) return topDiff; // small tolerance

        // Secondary: left
        return ra.left - rb.left;
      });

      sorted.forEach((card, index) => {
        // restart animation cleanly
        card.classList.remove("animate__animated", "animate__fadeInRight");
        card.style.animationDelay = `${index * 90}ms`;
        void card.offsetWidth; // force reflow

        card.style.opacity = "1";
        card.classList.add("animate__animated", "animate__fadeInRight");
      });
    }

    inView(
      container,
      () => {
        if (hasAnimated) return;
        hasAnimated = true;

        // wait a tick so layout is stable (images/fonts)
        requestAnimationFrame(() => {
          requestAnimationFrame(animateStaggeredByPosition);
        });
      },
      { amount: 0.2 },
    );
  });
</script>

<style>
  body.dark #project-cards > li {
    background-color: #454545;
    border-color: #6d6d6d;
  }

  body.dark #project-cards > li:hover {
    background-color: #5b5b5b;
    border-color: #7d7d7d;
  }

  body.dark #project-cards > li:focus {
    border-color: #92c2fe;
  }

  body.dark #project-cards > li h1,
  body.dark #project-cards > li h2,
  body.dark #project-cards > li p,
  body.dark #project-cards > li span {
    color: #f6f6f6;
  }
</style>
