---
import MainLayout from "../layouts/MainLayout.astro";
import Button from "../components/Button.astro";
import "../styles/global.css";

export async function getStaticPaths() {
  const response = await fetch("https://bbmabdbbjpfqoapbtstm.supabase.co/rest/v1/portfolio_cases", {
    headers: {
      apikey:
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJibWFiZGJianBmcW9hcGJ0c3RtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI0NjkwNDYsImV4cCI6MjA1ODA0NTA0Nn0.gFnw6GZiMFOCMwy6rAcQFzoK0_qUJCwKNpl-XGzy574",
    },
  });

  const projects = await response.json();

  return projects.map((project) => ({
    params: { slug: project.slug },
    props: {
      project,
      allProjects: projects,
    },
  }));
}

const { project, allProjects } = Astro.props;

// ‚úÖ Sort by ID (or change to .year or .created_at if needed)
const sortedProjects = [...allProjects].sort((a, b) => a.id - b.id);

// üîÅ Find current project in sorted array
const currentIndex = sortedProjects.findIndex((p) => p.slug === project.slug);

// ‚¨ÖÔ∏è ‚û°Ô∏è Get previous and next projects
const prevProject = currentIndex > 0 ? sortedProjects[currentIndex - 1] : null;
const nextProject = currentIndex < sortedProjects.length - 1 ? sortedProjects[currentIndex + 1] : null;
---

<MainLayout title={project.name} description={project.description} ogtitle={project.name} ogdescription={project.description}>
  <section id="project" class="relative grid grid-cols-12 max-w-6xl mx-auto pt-mobil-top md:mt-24 mt-12 md:px-0 px-6">
    <!-- Navigation -->
    <nav id="navigation" class="col-span-12 md:text-left text-center md:text-p-desktop flex flex-wrap justify-between items-center gap-4 mb-8">
      <a
        href="/"
        class="py-1 md:text-p-desktop text-[15px] hover:text-red-500 transition duration-300 focus:outline-none focus:ring-2 focus:ring-red-300"
        aria-label="Go to homepage">‚Üë Back to homepage</a
      >

      <div class="flex gap-4 ml-auto">
        {
          prevProject && (
            <a
              href={`/${prevProject.slug}`}
              class="py-1 md:text-p-desktop text-[15px] hover:text-red-500 transition duration-300 focus:outline-none focus:ring-2 focus:ring-red-300 text-gray-800"
              aria-label={`Go to previous project: ${prevProject.name}`}
            >
              ‚Üê {prevProject.name}
            </a>
          )
        }
        {
          nextProject && (
            <a
              href={`/${nextProject.slug}`}
              class="py-1 md:text-p-desktop text-[15px] hover:text-red-500 transition duration-300 focus:outline-none focus:ring-2 focus:ring-red-300 text-gray-800"
              aria-label={`Go to next project: ${nextProject.name}`}
            >
              {nextProject.name} ‚Üí
            </a>
          )
        }
      </div>
    </nav>

    <!-- Header -->
    <header id="project-header" class="col-span-12 md:mb-12 mb-8 md:text-left text-center">
      <h1 id="project-title" class="font-bold md:text-h2-desktop text-h4-desktop md:mb-4 mb-2 text-gray-950">{project.name}</h1>
      <h2 id="project-subtitle" class="italic font-light md:text-h4-desktop text-[18.5px] text-gray-800 leading-7">{project.year}</h2>
    </header>

    <!-- Content Grid -->
    <div class="col-span-12 grid md:grid-cols-2 grid-cols-1 gap-12">
      <img
        id="project-image"
        src={project.image}
        alt={project.name}
        class="w-full rounded-xl object-cover border-l-4 border border-gray-200"
        loading="lazy"
      />

      <div class="space-y-6">
        <p id="project-description" class="text-gray-800">{project.description}</p>

        {
          project.tools && (
            <div id="tools-list">
              <h3 id="tools-title" class="text-h4-mobile italic font-bold text-gray-950 mb-2">
                Tools used:
              </h3>
              <div class="flex flex-wrap gap-2 mb-12">
                {project.tools.map((tool) => (
                  <span class="rounded-full px-4 py-2 font-semibold border border-red-700 bg-red-700 text-gray-50 text-sm uppercase">{tool}</span>
                ))}
              </div>
            </div>
          )
        }
        <div id="project-link" class="btn-container">
          <a href={project.url} target="_blank" rel="noopener noreferrer" aria-label={`View project: ${project.name}`}>
            <Button variant="secondary" size="small">View project</Button>
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Gallery Section -->
  <section id="gallery" class="max-w-6xl grid grid-cols-12 mx-auto md:pt-desktop-top pt-mobil-top md:pb-desktop-bottom pb-mobil-bottom md:px-0 px-6">
    <div class="col-span-12 bg-gray-100 border-l-4 border-gray-200 rounded-2xl p-6">
      <h3 class="text-h4-desktop font-bold text-gray-950 mb-4">Curious to see more?</h3>
      <p id="gallery-text" class="text-gray-800 mb-8">
        Explore images, videos, and media from my projects in the gallery. From sketches and wireframes to moodboards and screenshots.
      </p>
      <a href="/gallery" aria-label="Go to gallery">
        <Button variant="secondary" size="small">Go to <em>Gallery</em></Button>
      </a>
    </div>
  </section>
</MainLayout>

<style>
  body.dark #project-header h1,
  body.dark #project-header h2,
  body.dark p,
  body.dark h3,
  body.dark span {
    color: #f6f6f6;
  }

  body.dark a {
    color: #f6f6f6;
  }

  body.dark a:hover {
    color: #ff1f1f;
  }

  body.dark #project-image {
    border-color: #6d6d6d;
  }

  body.dark section:last-child div {
    background-color: #454545;
    border-color: #6d6d6d;
  }
</style>

<script>
  import { inView } from "motion";

  const elements = [
    { selector: "#project-title", animation: "animate__backInRight" },
    { selector: "#project-subtitle", animation: "animate__backInLeft" },
    { selector: "#project-description", animation: "animate__fadeInRight" },
  ];

  document.addEventListener("DOMContentLoaded", () => {
    if (document.body.classList.contains("reduce-motion")) return;

    elements.forEach(({ selector, animation }) => {
      document.querySelectorAll(selector).forEach((el) => {
        inView(el, () => el.classList.add("animate__animated", animation));
      });
    });

    document.querySelectorAll("#tools-list").forEach((tool, i) => {
      inView(tool, () => {
        tool.classList.add("animate__animated", "animate__rotateInDownLeft");
        tool.style.animationDelay = `${i * 0.2}s`;
      });
    });

    const elementmedanimation6 = document.querySelector("#project-link");
    inView(elementmedanimation6, () => {
      elementmedanimation6.classList.add("animate__animated", "animate__fadeInUp");
    });

    const elementmedanimation7 = document.querySelector("#gallery");
    inView(elementmedanimation7, () => {
      elementmedanimation7.classList.add("animate__animated", "animate__fadeInRight");
    });
  });
</script>
