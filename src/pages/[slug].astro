---
import MainLayout from "../layouts/MainLayout.astro";
import Button from "../components/Button.astro";
import "../styles/global.css";

export async function getStaticPaths() {
  const response = await fetch("https://bbmabdbbjpfqoapbtstm.supabase.co/rest/v1/portfolio_cases", {
    headers: {
      apikey:
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJibWFiZGJianBmcW9hcGJ0c3RtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI0NjkwNDYsImV4cCI6MjA1ODA0NTA0Nn0.gFnw6GZiMFOCMwy6rAcQFzoK0_qUJCwKNpl-XGzy574",
    },
  });

  const projects = await response.json();

  return projects.map((project) => ({
    params: { slug: project.slug },
    props: {
      project,
      allProjects: projects,
    },
  }));
}

interface Project {
  id: number;
  slug: string;
  name: string;
  description: string;
  year: string;
  image: string;
  tools?: string[];
  url: string;
  ai_used?: boolean;
}

const { project, allProjects } = Astro.props as { project: Project; allProjects: Project[] };

// ‚úÖ Sort by ID (or change to .year or .created_at if needed)
const sortedProjects = [...allProjects].sort((a, b) => a.id - b.id);

// üîÅ Find current project in sorted array
const currentIndex = sortedProjects.findIndex((p) => p.slug === project.slug);

// ‚¨ÖÔ∏è ‚û°Ô∏è Get previous and next projects
const prevProject = currentIndex > 0 ? sortedProjects[currentIndex - 1] : null;
const nextProject = currentIndex < sortedProjects.length - 1 ? sortedProjects[currentIndex + 1] : null;
---

<MainLayout title={project.name} description={project.description} ogtitle={project.name} ogdescription={project.description}>
  <section id="project" class="relative grid grid-cols-12 max-w-6xl mx-auto pt-mobil-top md:mt-24 mt-12 md:px-0 px-6">
    <!-- Navigation -->
    <nav
      id="navigation"
      class="col-span-12 md:text-left text-center md:text-p-desktop flex flex-wrap justify-between items-center gap-4 mb-8 md:pt-0 pt-4"
    >
      <a
        href="/"
        class="py-1 md:text-p-desktop text-[15px] hover:text-blue-400 transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-300"
        aria-label="Go to homepage">‚Üë Back to homepage</a
      >

      <div class="flex gap-4 ml-auto">
        {
          prevProject && prevProject.slug !== "no-project" && (
            <a
              href={`/${prevProject.slug}`}
              class="py-1 md:text-p-desktop text-[15px] hover:text-blue-400 transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-300 text-gray-800"
              aria-label={`Go to previous project: ${prevProject.name}`}
            >
              ‚Üê {prevProject.name}
            </a>
          )
        }
        {
          nextProject && nextProject.slug !== "no-project" && (
            <a
              href={`/${nextProject.slug}`}
              class="py-1 md:text-p-desktop text-[15px] hover:text-blue-400 transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-300 text-gray-800"
              aria-label={`Go to next project: ${nextProject.name}`}
            >
              {nextProject.name} ‚Üí
            </a>
          )
        }
      </div>
    </nav>

    <!-- Header -->
    <header id="project-header" class="col-span-12 md:mb-12 mb-8 md:text-left text-center">
      <h1 id="project-title" class="font-bold md:text-h2-desktop text-h4-desktop md:mb-4 mb-2 text-gray-950">{project.name}</h1>
      <h2 id="project-subtitle" class="italic font-light md:text-h4-desktop text-[18.5px] text-gray-800 leading-7">{project.year}</h2>
    </header>

    <!-- Figma Notice -->
    {
      project.slug === "vibeloop" || project.slug === "ungeforum"
        ? (project.slug === "vibeloop" || project.slug === "ungeforum") && (
            <div
              class="flex items-center gap-3 col-span-12 bg-[#E9EFF4] border border-l-4 border-[#7E9BB5] rounded-full md:p-4 p-3 md:w-[35rem] w-full mb-8"
              id="figma-notice"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="30"
                height="30"
                fill="currentColor"
                class="text-[#5C728A] flex-shrink-0"
                viewBox="0 0 16 16"
              >
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16" />
                <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0M7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0z" />
              </svg>
              <div>
                <p class="text-[#5C728A] md:text-[14.5px] text-[12px]">This project is presented as an interactive prototype created in Figma</p>
              </div>
            </div>
          )
        : null
    }

    <!-- Content Grid -->
    <div class="col-span-12 grid md:grid-cols-2 grid-cols-1 gap-12">
      <img
        id="project-image"
        src={project.image}
        alt={project.name}
        class="w-full rounded-xl object-cover border-l-4 border border-gray-200"
        loading="lazy"
      />

      <div class="space-y-6">
        <p id="project-description" class="text-gray-800">{project.description}</p>

        {
          project.tools && (
            <div id="tools-list">
              <h3 id="tools-title" class="text-h4-mobile italic font-bold text-gray-950 mb-2">
                Tools used:
              </h3>
              <div class="flex flex-wrap gap-2 mb-12">
                {project.tools.map((tool) => (
                  <span class="rounded-full px-4 py-2 font-semibold border border-blue-500 bg-blue-500 text-gray-50 text-sm uppercase">{tool}</span>
                ))}
              </div>
            </div>
          )
        }
        <div id="project-link" class="btn-container">
          <a href={project.url} target="_blank" rel="noopener noreferrer" aria-label={`View project: ${project.name}`}>
            <Button variant="secondary" size="small">
              {project.slug === "escape-room" ? "Read concept PDF" : "View project"}
            </Button>
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Related Projects Section -->
  <section
    id="related-projects"
    class="max-w-6xl grid grid-cols-12 mx-auto md:pt-desktop-top pt-mobil-top md:pb-desktop-bottom pb-mobil-bottom md:px-0 px-6"
  >
    <div id="related-projects-title" class="col-span-12 mb-4">
      <h2 class="text-h3-desktop font-bold text-gray-950 mb-2">More projects</h2>
    </div>

    {
      (() => {
        const randomProjects = sortedProjects.sort(() => 0.5 - Math.random()).slice(0, 3);
        return (
          <div class="col-span-12 grid md:grid-cols-3 grid-cols-1 gap-6">
            {randomProjects.map((proj) => (
              <a href={`/${proj.slug}`} class="group">
                <div
                  id="related-project-card"
                  class="rounded-xl overflow-hidden bg-gradient-to-br from-gray-50 to-gray-100 rounded-3xl border-l-4 border border-gray-200 hover:border-gray-300 transition duration-300"
                >
                  <img src={proj.image} alt={proj.name} class="w-full h-48 object-cover" loading="lazy" />
                  <div id="related-project-info" class="p-4 border-t border-gray-200 group-hover:border-gray-300 transition duration-300">
                    <h3 id="related-project-title" class="text-h4-mobile font-bold text-gray-950 mb-2">
                      {proj.name}
                    </h3>
                    <p id="related-project-year" class="text-sm text-gray-800">
                      {proj.year}
                    </p>
                  </div>
                </div>
              </a>
            ))}
          </div>
        );
      })()
    }
  </section>
</MainLayout>

<style>
  body.dark #project-header h1,
  body.dark #project-header h2,
  body.dark p,
  body.dark h3,
  body.dark span {
    color: #f6f6f6;
  }

  body.dark #figma-notice {
    background-color: #38476f;
    border-color: #6074a4;
    color: #f6f6f6;
  }

  body.dark #figma-notice svg {
    color: #f6f6f6;
  }

  body.dark a {
    color: #f6f6f6;
  }

  body.dark a:hover {
    color: #5fa0fb;
  }

  body.dark #project-image {
    border-color: #6d6d6d;
  }

  body.dark section:last-child .col-span-12 > div > a > div {
    border-color: #6d6d6d;
    background: linear-gradient(to bottom right, #3a3a3a, #2d2d2d);
  }

  body.dark #related-projects h2 {
    color: #f6f6f6;
  }

  body.dark #related-projects a > div {
    border-color: #6d6d6d;
    background: linear-gradient(to bottom right, #3a3a3a, #2d2d2d);
  }

  body.dark #related-projects a > div:hover {
    border-color: #d1d1d1;
    background: linear-gradient(to bottom right, #3a3a3a, #2d2d2d);
  }

  body.dark #related-projects a > div > div {
    border-color: #6d6d6d;
  }

  body.dark #related-projects a > div > div:hover {
    border-color: #d1d1d1;
  }
</style>

<script>
  import { inView } from "motion";

  const elements = [
    { selector: "#project-title", animation: "animate__backInRight" },
    { selector: "#project-subtitle", animation: "animate__backInLeft" },
    { selector: "#project-description", animation: "animate__fadeInRight" },
  ];

  document.addEventListener("DOMContentLoaded", () => {
    if (document.body.classList.contains("reduce-motion")) return;

    elements.forEach(({ selector, animation }) => {
      document.querySelectorAll(selector).forEach((el) => {
        inView(el, () => el.classList.add("animate__animated", animation));
      });
    });

    document.querySelectorAll("#tools-list").forEach((tool, i) => {
      inView(tool, () => {
        tool.classList.add("animate__animated", "animate__rotateInDownLeft");
        (tool as HTMLElement).style.animationDelay = `${i * 0.2}s`;
      });
    });

    const elementmedanimation6 = document.querySelector("#project-link");
    inView(elementmedanimation6, () => {
      elementmedanimation6.classList.add("animate__animated", "animate__fadeInUp");
    });

    const elementmedanimation5 = document.querySelector("#project-image");
    inView(elementmedanimation5, () => {
      elementmedanimation5.classList.add("animate__animated", "animate__fadeInLeft");
    });

    const elementmedanimation7 = document.querySelector("#gallery");
    inView(elementmedanimation7, () => {
      elementmedanimation7.classList.add("animate__animated", "animate__fadeInRight");
    });

    const elementmedanimation8 = document.querySelector("#figma-notice");
    inView(elementmedanimation8, () => {
      elementmedanimation8.classList.add("animate__animated", "animate__backInDown");
    });

    const elementmedanimation10 = document.querySelector("#ai-notice");
    inView(elementmedanimation10, () => {
      elementmedanimation10.classList.add("animate__animated", "animate__backInDown");
    });

    const cards = document.querySelectorAll("#related-projects a > div");
    cards.forEach((card) => {
      const cardEl = card as HTMLElement;
      inView(cardEl, () => {
        cardEl.classList.add("animate__animated", "animate__fadeInUp");
        cardEl.style.animationDelay = `${Math.random() * 0.5}s`; // Random delay for a staggered effect
      });
    });

    const elementmedanimation9 = document.querySelector("#related-projects-title");
    inView(elementmedanimation9, () => {
      elementmedanimation9.classList.add("animate__animated", "animate__backInRight");
    });
  });
</script>
